# Legal Agent System v2.0

ä¸€ä¸ªåŸºäºå¤šAgentæ¶æ„çš„ä¸“ä¸šæ³•å¾‹æ™ºèƒ½åŠ©æ‰‹ç³»ç»Ÿï¼ŒåŒ…å«CoreAgentè·¯ç”±ã€SpecializedAgentæ‰§è¡Œã€ä¸¥æ ¼Criticè¯„ä¼°ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ¿€æ´»condaç¯å¢ƒ
conda activate /home/mnt/xieqinghongbing/env/open_manus

# è®¾ç½®ç¯å¢ƒå˜é‡
export DASHSCOPE_API_KEY="sk-5d4975fe68f24d83809ac3c7bf7468ba"
export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
export BOCHA_API_KEY="your_bocha_api_key"  # å¯é€‰ï¼Œç”¨äºweb_search
```

### 2. å®‰è£…ä¾èµ–

```bash
cd /home/mnt/xieqinghongbing/code/xiazhaoyuan/Agent
pip install -r requirements.txt
```

### 3. è¿è¡Œç³»ç»Ÿ

#### æ–¹å¼1ï¼šä½¿ç”¨Streamlitå‰ç«¯ï¼ˆæ¨èï¼‰

```bash
streamlit run app.py
# æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬
bash run_app.sh
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ˜¾ç¤ºçš„URLï¼ˆé€šå¸¸æ˜¯ http://localhost:8501ï¼‰

#### æ–¹å¼2ï¼šè¿è¡Œè¯„ä¼°

```bash
python eval/run_eval.py --data_path data/test_example/zixun_gpt4.json --max_cases 3 --output eval/results.json
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
Agent/
â”œâ”€â”€ agent/                    # Agentæ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ base.py              # BaseAgentåŸºç±»
â”‚   â”œâ”€â”€ react.py             # ReActAgentï¼ˆæ€è€ƒ-è¡ŒåŠ¨å¾ªç¯ï¼‰
â”‚   â”œâ”€â”€ toolcall.py          # ToolCallAgentï¼ˆå·¥å…·è°ƒç”¨ï¼‰
â”‚   â”œâ”€â”€ agent.py             # é€šç”¨Agentç±»
â”‚   â”œâ”€â”€ core_agent.py        # CoreAgentï¼ˆè·¯ç”±å±‚ï¼‰
â”‚   â””â”€â”€ specialized_agent.py # SpecializedAgentï¼ˆæ‰§è¡Œå±‚ï¼‰
â”œâ”€â”€ flow/                     # æµç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ base.py              # BaseFlowåŸºç±»
â”‚   â””â”€â”€ legal_flow.py        # LegalFlowï¼ˆæ³•å¾‹æµç¨‹ï¼‰
â”œâ”€â”€ tools/                    # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ web_search.py        # Bocha APIæœç´¢å·¥å…·
â”‚   â”œâ”€â”€ python_executor_tool.py
â”‚   â”œâ”€â”€ ocr_tool.py
â”‚   â”œâ”€â”€ tool_registry.py     # å·¥å…·æ³¨å†Œè¡¨
â”‚   â””â”€â”€ tool_manager.py      # å·¥å…·ç®¡ç†å™¨
â”œâ”€â”€ models/                   # æ¨¡å‹æ¨¡å—ï¼ˆåˆå¹¶äº†embeddingå’Œllmï¼‰
â”‚   â”œâ”€â”€ llm.py               # LLMæ¨¡å‹
â”‚   â””â”€â”€ model.py             # Embeddingæ¨¡å‹
â”œâ”€â”€ memory/                   # è®°å¿†ç³»ç»Ÿï¼ˆåˆå¹¶äº†memoryå’Œcontextï¼‰
â”‚   â”œâ”€â”€ session.py           # çŸ­æœŸè®°å¿†ï¼ˆä¼šè¯ï¼‰
â”‚   â”œâ”€â”€ global_memory.py     # å…¨å±€è®°å¿†ï¼ˆState Memoryï¼‰
â”‚   â”œâ”€â”€ vector_db.py         # é•¿æœŸè®°å¿†ï¼ˆå‘é‡æ•°æ®åº“ï¼‰
â”‚   â”œâ”€â”€ manager.py           # ä¸Šä¸‹æ–‡ç®¡ç†å™¨
â”‚   â””â”€â”€ refiner.py           # ä¸Šä¸‹æ–‡ç²¾ç‚¼å™¨
â”œâ”€â”€ prompt/                   # é›†ä¸­åŒ–Promptæ¨¡æ¿
â”‚   â”œâ”€â”€ core_agent_prompts.py
â”‚   â”œâ”€â”€ specialized_agent_prompts.py
â”‚   â””â”€â”€ agent_prompts.py
â”œâ”€â”€ eval/                     # è¯„ä¼°æ¨¡å—
â”‚   â”œâ”€â”€ evaluator.py         # è¯„ä¼°å™¨
â”‚   â”œâ”€â”€ baselines.py         # åŸºçº¿ç³»ç»Ÿ
â”‚   â””â”€â”€ utils.py             # è¯„ä¼°å·¥å…·
â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”œâ”€â”€ schema.py                 # æ•°æ®æ¨¡å¼å®šä¹‰
â”œâ”€â”€ app.py                    # Streamlitå‰ç«¯åº”ç”¨
â””â”€â”€ run_app.sh               # å¯åŠ¨è„šæœ¬
```

## âœ¨ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### å¤šAgentæ¶æ„

- **CoreAgentï¼ˆè·¯ç”±å±‚ï¼‰**: 
  - è¯†åˆ«æ³•å¾‹é¢†åŸŸå’Œæ„å›¾
  - æå–å…³é”®å®ä½“ï¼ˆäººåã€é‡‘é¢ã€æ—¶é—´ã€åœ°ç‚¹ï¼‰
  - ç»´æŠ¤State Memoryï¼ˆç»“æ„åŒ–çŠ¶æ€ï¼‰
  - æ™ºèƒ½è·¯ç”±åˆ°SpecializedAgent
  
- **SpecializedAgentï¼ˆæ‰§è¡Œå±‚ï¼‰**:
  - é¢†åŸŸç‰¹å®šçš„SOPï¼ˆæ ‡å‡†æ“ä½œç¨‹åºï¼‰æ³¨å…¥
  - ReActå¾ªç¯æ‰§è¡Œï¼ˆThink-Act-Observeï¼‰
  - Native Function Callingå·¥å…·é€‰æ‹©
  - ä¸¥æ ¼çš„è‡ªæˆ‘è¯„ä¼°ï¼ˆCriticæœºåˆ¶ï¼‰

### å·¥å…·ç³»ç»Ÿ

- **Webæœç´¢**: Bocha APIï¼ˆé«˜è´¨é‡æ‘˜è¦ï¼‰
- **Pythonæ‰§è¡Œå™¨**: ä»£ç æ‰§è¡Œå’Œè®¡ç®—
- **OCRå·¥å…·**: å›¾ç‰‡æ–‡å­—è¯†åˆ«
- **è®¡ç®—å™¨**: æ•°å­¦è®¡ç®—
- **æ–‡ä»¶è¯»å–**: æ–‡ä»¶å†…å®¹è¯»å–
- **æ—¥æœŸæ—¶é—´**: æ—¶é—´ç›¸å…³æ“ä½œ

### è®°å¿†ç³»ç»Ÿ

- **çŸ­æœŸè®°å¿†ï¼ˆSessionï¼‰**: å­˜å‚¨å½“å‰ä¼šè¯çš„å¯¹è¯å†å²
- **å…¨å±€è®°å¿†ï¼ˆGlobalMemoryï¼‰**: å­˜å‚¨å½“å‰æ¡ˆä»¶çš„å·²çŸ¥äº‹å®ï¼ˆState Memoryï¼‰
- **é•¿æœŸè®°å¿†ï¼ˆVectorDatabaseï¼‰**: å‘é‡åŒ–çš„å†å²å¯¹è¯è®°å½•

### æ™ºèƒ½ç‰¹æ€§

- **Native Function Calling**: LLMåŸç”Ÿå·¥å…·è°ƒç”¨ï¼Œæ— éœ€embeddingåŒ¹é…
- **ä¸¥æ ¼Criticæœºåˆ¶**: è‡ªåŠ¨è¯„ä¼°å›ç­”è´¨é‡ï¼Œä¸é€šè¿‡åˆ™é‡æ–°æœç´¢å’Œç”Ÿæˆ
- **å¤åˆæœç´¢è¯ç”Ÿæˆ**: "æ ¸å¿ƒæ³•å¾‹æ¦‚å¿µ + ç”¨æˆ·åœºæ™¯ + æ³•æ¡"çš„ç²¾å‡†æœç´¢
- **é¢†åŸŸç‰¹å®šSOP**: ä¸åŒæ³•å¾‹é¢†åŸŸæ³¨å…¥ä¸åŒçš„æ€ç»´æ¨¡å‹
- **å®æ—¶çŠ¶æ€æ˜¾ç¤º**: å‰ç«¯å®æ—¶æ˜¾ç¤ºæ‰§è¡Œé˜¶æ®µå’Œè¿›åº¦

## ğŸ”„ ç³»ç»Ÿè¿è¡Œé€»è¾‘

### æ•´ä½“æ¶æ„æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (app.py)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Streamlit UI: ç”¨æˆ·è¾“å…¥ â†’ å®æ—¶çŠ¶æ€æ˜¾ç¤º â†’ ç»“æœå±•ç¤º        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LegalFlow (åè°ƒå±‚)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  execute(user_input, status_callback)                    â”‚   â”‚
â”‚  â”‚    â†“                                                      â”‚   â”‚
â”‚  â”‚  core_agent.process_message(user_input, status_callback) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CoreAgent (è·¯ç”±å±‚)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Phase 1: æ„å›¾è¯†åˆ«ä¸å®ä½“æå–                              â”‚   â”‚
â”‚  â”‚    â”œâ”€ identify_domain_and_intent()                       â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ ä½¿ç”¨LLMè¯†åˆ«: domain, intent                    â”‚   â”‚
â”‚  â”‚    â”œâ”€ update_state_memory()                              â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ ä¿å­˜åˆ° GlobalMemory                            â”‚   â”‚
â”‚  â”‚    â””â”€ å¦‚æœæ˜¯ Non_Legal â†’ handle_non_legal_query()        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Phase 2: æ™ºèƒ½è·¯ç”±                                        â”‚   â”‚
â”‚  â”‚    â”œâ”€ get_or_create_sub_agent(domain, intent)            â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ åˆ›å»º/è·å– SpecializedAgent                     â”‚   â”‚
â”‚  â”‚    â””â”€ ä¼ é€’ status_callback                               â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Phase 3: ä¸“ä¸šAgentæ‰§è¡Œ                                   â”‚   â”‚
â”‚  â”‚    â””â”€ sub_agent.execute_task(...)                        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Phase 4: è¿”å›ç»“æœ                                        â”‚   â”‚
â”‚  â”‚    â””â”€ return result                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SpecializedAgent (æ‰§è¡Œå±‚)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  execute_task(user_message, domain, intent, ...)         â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Step 1: åˆ¶å®šè®¡åˆ’                                         â”‚   â”‚
â”‚  â”‚    â””â”€ _create_plan() â†’ æ ¹æ®intentç”ŸæˆSOPè®¡åˆ’             â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Step 2: ReActå¾ªç¯æ‰§è¡Œ (runæ–¹æ³•)                         â”‚   â”‚
â”‚  â”‚    â”œâ”€ think() â†’ åˆ†æé—®é¢˜ï¼Œå†³å®šè°ƒç”¨å·¥å…·                   â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ LLM + Native Function Calling                  â”‚   â”‚
â”‚  â”‚    â”œâ”€ act() â†’ æ‰§è¡Œå·¥å…·è°ƒç”¨                               â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€ web_search (Bocha API)                        â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€ python_executor                               â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ ocr, calculator, etc.                         â”‚   â”‚
â”‚  â”‚    â””â”€ observe() â†’ è·å–å·¥å…·ç»“æœï¼Œç»§ç»­æ€è€ƒ                 â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Step 3: è‡ªæˆ‘è¯„ä¼° (Criticæœºåˆ¶)                           â”‚   â”‚
â”‚  â”‚    â”œâ”€ _self_evaluate_result()                            â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ ä½¿ç”¨ RESULT_EVALUATION_PROMPT ä¸¥æ ¼è¯„ä¼°         â”‚   â”‚
â”‚  â”‚    â”‚                                                      â”‚   â”‚
â”‚  â”‚    â”œâ”€ å¦‚æœè¯„ä¼°ä¸é€šè¿‡:                                    â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€ _generate_refined_search_query()              â”‚   â”‚
â”‚  â”‚    â”‚   â”‚   â””â”€ æ ¹æ®åé¦ˆç”Ÿæˆæ”¹è¿›çš„æœç´¢å…³é”®è¯               â”‚   â”‚
â”‚  â”‚    â”‚   â”œâ”€ é‡æ–°æ‰§è¡Œ web_search                            â”‚   â”‚
â”‚  â”‚    â”‚   â””â”€ é‡æ–°ç”Ÿæˆå›ç­”                                   â”‚   â”‚
â”‚  â”‚    â”‚                                                      â”‚   â”‚
â”‚  â”‚    â””â”€ æœ€å¤šè¿›è¡Œ 2 è½®è¯„ä¼°å’Œé‡æ–°æœç´¢                        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  Step 4: è¿”å›æœ€ç»ˆç»“æœ                                     â”‚   â”‚
â”‚  â”‚    â””â”€ return result                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†æ‰§è¡Œæµç¨‹

#### 1. ç”¨æˆ·è¾“å…¥é˜¶æ®µ

```
User Input
    â†“
app.py: process_message()
    â†“
ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° st.session_state.messages
    â†“
æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    â†“
åˆ›å»º status_callback (å®æ—¶çŠ¶æ€æ›´æ–°)
    â†“
è°ƒç”¨ legal_flow.execute(user_input, status_callback)
```

#### 2. CoreAgent è·¯ç”±é˜¶æ®µ

**2.1 æ„å›¾è¯†åˆ«**
```
CoreAgent.process_message()
    â†“
è·å–å¯¹è¯å†å² (conversation_history)
    â†“
identify_domain_and_intent(user_message, conversation_history)
    â”œâ”€ ä½¿ç”¨ LLM åˆ†æç”¨æˆ·é—®é¢˜
    â”œâ”€ è¯†åˆ« LegalDomain (Family_Law, Criminal_Law, etc.)
    â”œâ”€ è¯†åˆ« LegalIntent (QA_Retrieval, Case_Analysis, etc.)
    â””â”€ æå–å…³é”®å®ä½“ (persons, amounts, dates, locations)
    â†“
update_state_memory(domain, intent, entities)
    â””â”€ ä¿å­˜åˆ° GlobalMemory (State Memory)
    â†“
å¦‚æœæ˜¯ Non_Legal
    â””â”€ handle_non_legal_query() â†’ ç®€å•å›ç­” + å¼•å¯¼
```

**2.2 æ™ºèƒ½è·¯ç”±**
```
get_or_create_sub_agent(domain, intent)
    â”œâ”€ ç”Ÿæˆ key = f"{domain}_{intent}"
    â”œâ”€ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ SpecializedAgent
    â”‚   â””â”€ æ³¨å…¥é¢†åŸŸç‰¹å®šçš„ SOP (Standard Operating Procedure)
    â””â”€ è¿”å› sub_agent
```

#### 3. SpecializedAgent æ‰§è¡Œé˜¶æ®µ

**3.1 åˆ¶å®šè®¡åˆ’**
```
_create_plan(user_message, domain, intent)
    â”œâ”€ æ ¹æ® intent é€‰æ‹©è®¡åˆ’æ¨¡æ¿
    â”‚   â”œâ”€ QA_Retrieval â†’ _create_qa_retrieval_plan()
    â”‚   â”œâ”€ Case_Analysis â†’ _create_case_analysis_plan()
    â”‚   â”œâ”€ Calculation â†’ _create_calculation_plan()
    â”‚   â””â”€ ...
    â””â”€ è¿”å›æ‰§è¡Œè®¡åˆ’æ–‡æœ¬
    â†“
å°†è®¡åˆ’æ·»åŠ åˆ° memory
```

**3.2 ReAct å¾ªç¯æ‰§è¡Œ**
```
run(user_message)
    â†“
while current_step < max_steps and state != FINISHED:
    â”œâ”€ step()
    â”‚   â”œâ”€ think()
    â”‚   â”‚   â”œâ”€ è·å–æœ€è¿‘æ¶ˆæ¯ (get_recent_messages)
    â”‚   â”‚   â”œâ”€ è°ƒç”¨ LLM.chat_with_tools()
    â”‚   â”‚   â”‚   â””â”€ æä¾› tools_schema (Native Function Calling)
    â”‚   â”‚   â”œâ”€ è§£æ tool_calls (å¦‚æœæœ‰)
    â”‚   â”‚   â””â”€ æ·»åŠ åˆ° current_tool_calls
    â”‚   â”‚
    â”‚   â””â”€ act() (å¦‚æœæœ‰å·¥å…·è°ƒç”¨)
    â”‚       â”œâ”€ éå† current_tool_calls
    â”‚       â”œâ”€ execute_tool(tool_call)
    â”‚       â”‚   â”œâ”€ ä» available_functions è·å–å·¥å…·å‡½æ•°
    â”‚       â”‚   â”œâ”€ è§£æå‚æ•° (JSON)
    â”‚       â”‚   â”œâ”€ æ‰§è¡Œå·¥å…· (åŒæ­¥/å¼‚æ­¥)
    â”‚       â”‚   â””â”€ è¿”å›ç»“æœ
    â”‚       â””â”€ å°†å·¥å…·ç»“æœæ·»åŠ åˆ° memory
    â”‚
    â””â”€ æ£€æŸ¥æ˜¯å¦å®Œæˆ
        â”œâ”€ å¦‚æœæœ‰æœ€ç»ˆå›ç­” â†’ state = FINISHED
        â””â”€ å¦åˆ™ç»§ç»­å¾ªç¯
    â†“
æå–æœ€ç»ˆå›ç­” (æœ€åä¸€æ¡ assistant æ¶ˆæ¯)
    â†“
è¿”å› result
```

**3.3 è‡ªæˆ‘è¯„ä¼° (Criticæœºåˆ¶)**
```
_self_evaluate_result(user_message, result, domain, intent)
    â”œâ”€ ä½¿ç”¨ RESULT_EVALUATION_PROMPT
    â”œâ”€ è°ƒç”¨ LLM è¯„ä¼° (temperature=0.0, ä¸¥æ ¼æ¨¡å¼)
    â”œâ”€ è§£æ JSON å“åº”
    â”‚   â”œâ”€ is_acceptable: true/false
    â”‚   â””â”€ feedback: å…·ä½“åé¦ˆ
    â””â”€ è¿”å› (is_acceptable, feedback)
    â†“
å¦‚æœ is_acceptable == False:
    â”œâ”€ critic_round += 1
    â”œâ”€ å¦‚æœ critic_round < max_critic_rounds (2):
    â”‚   â”œâ”€ _generate_refined_search_query()
    â”‚   â”‚   â””â”€ æ ¹æ®åé¦ˆç”Ÿæˆæ”¹è¿›çš„æœç´¢å…³é”®è¯
    â”‚   â”œâ”€ æ‰§è¡Œæ–°çš„ web_search
    â”‚   â”œâ”€ å°†æœç´¢ç»“æœæ·»åŠ åˆ° memory
    â”‚   â”œâ”€ é‡æ–°ç”Ÿæˆå›ç­” (åŸºäºæ–°æœç´¢ç»“æœ)
    â”‚   â””â”€ å†æ¬¡è¯„ä¼° (å›åˆ°å¾ªç¯å¼€å§‹)
    â””â”€ å¦‚æœè¾¾åˆ°æœ€å¤§è½®æ•° â†’ è¿”å›å½“å‰ç»“æœ
```

#### 4. ç»“æœè¿”å›é˜¶æ®µ

```
SpecializedAgent.execute_task() è¿”å› result
    â†“
CoreAgent.process_message() è¿”å› result
    â†“
LegalFlow.execute() è¿”å› result
    â†“
app.py: process_message()
    â”œâ”€ æå– execution_logs
    â”œâ”€ ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯åˆ° st.session_state.messages
    â”‚   â””â”€ åŒ…å«: content, logs, error_occurred, timestamp
    â””â”€ st.rerun() â†’ è§¦å‘é¡µé¢åˆ·æ–°
    â†“
display_conversation()
    â”œâ”€ éå† st.session_state.messages
    â”œâ”€ æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ (ç”¨æˆ· + åŠ©æ‰‹)
    â”œâ”€ å¯¹äºåŠ©æ‰‹æ¶ˆæ¯:
    â”‚   â”œâ”€ æ˜¾ç¤ºå†…å®¹
    â”‚   â”œâ”€ æ˜¾ç¤ºæ¥æºé“¾æ¥ (render_sources)
    â”‚   â””â”€ æ˜¾ç¤ºå®Œæ•´æ‰§è¡Œæµç¨‹ (render_execution_timeline)
    â””â”€ å®Œæˆæ˜¾ç¤º
```

### å…³é”®ç»„ä»¶è¯´æ˜

#### 1. State Memory (GlobalMemory)
- **ä½œç”¨**: å­˜å‚¨å½“å‰æ¡ˆä»¶çš„å·²çŸ¥äº‹å®
- **å†…å®¹**: domain, intent, entities (persons, amounts, dates, locations)
- **æ›´æ–°æ—¶æœº**: CoreAgent è¯†åˆ«åç«‹å³æ›´æ–°
- **ç”¨é€”**: é˜²æ­¢æ¨¡å‹é—å¿˜å…³é”®ä¿¡æ¯ï¼Œå‰ç«¯æ˜¾ç¤ºä»»åŠ¡è¯†åˆ«ç»“æœ

#### 2. Native Function Calling
- **å®ç°**: LLM åŸç”Ÿæ”¯æŒçš„å·¥å…·è°ƒç”¨æœºåˆ¶
- **å·¥å…·æ³¨å†Œ**: ToolRegistry ç»Ÿä¸€ç®¡ç†
- **å·¥å…·åˆ—è¡¨**: web_search, python_executor, calculator, ocr, etc.
- **ä¼˜åŠ¿**: æ— éœ€ embedding åŒ¹é…ï¼ŒLLM ç›´æ¥é€‰æ‹©å·¥å…·

#### 3. Critic æœºåˆ¶
- **ä½ç½®**: SpecializedAgent å†…éƒ¨
- **è¯„ä¼°æ ‡å‡†**:
  1. æ³•æ¡å¼•ç”¨ç¼ºå¤± â†’ ä¸é€šè¿‡
  2. ä¸ç¡®å®šè¡¨è¿° â†’ ä¸é€šè¿‡
  3. åˆ†æç»“æ„ç¼ºå¤± â†’ ä¸é€šè¿‡
  4. ä¿¡æ¯ä¸å®Œæ•´ â†’ ä¸é€šè¿‡
  5. æ ¼å¼ä¸è§„èŒƒ â†’ ä¸é€šè¿‡
- **æ”¹è¿›æµç¨‹**: è¯„ä¼°ä¸é€šè¿‡ â†’ ç”Ÿæˆæ”¹è¿›æœç´¢è¯ â†’ é‡æ–°æœç´¢ â†’ é‡æ–°ç”Ÿæˆ â†’ å†æ¬¡è¯„ä¼°

#### 4. SOP (Standard Operating Procedure)
- **ä½œç”¨**: ä¸ºä¸åŒé¢†åŸŸæ³¨å…¥ç‰¹å®šçš„æ€ç»´æ¨¡å‹
- **ç¤ºä¾‹**:
  - **Criminal_Law**: çŠ¯ç½ªæ„æˆåˆ†æ â†’ ç½ªåè¾¨æ â†’ é‡åˆ‘æƒ…èŠ‚ â†’ æ³•æ¡ä¾æ®
  - **Family_Law**: æ³•å¾‹å…³ç³»æ¢³ç† â†’ äº‰è®®ç„¦ç‚¹ â†’ è¯·æ±‚æƒåŸºç¡€ â†’ åˆ©ç›Šå¹³è¡¡
  - **Procedural_Query**: ç®¡è¾–ç¡®å®š â†’ æ—¶æ•ˆå®¡æŸ¥ â†’ ææ–™æ¸…å• â†’ è´¹ç”¨ä¸å‘¨æœŸ
- **å®ç°**: é€šè¿‡ prompt æ¨¡æ¿æ³¨å…¥åˆ° SpecializedAgent çš„ system_prompt

#### 5. å¤åˆæœç´¢è¯ç”Ÿæˆ
- **ç­–ç•¥**: Query Transformation
- **æ ¼å¼**: `æ ¸å¿ƒæ³•å¾‹æ¦‚å¿µ + ç”¨æˆ·å…·ä½“åœºæ™¯å…³é”®è¯ + è§„å®š/æ³•æ¡`
- **ç¤ºä¾‹**: 
  - ç”¨æˆ·é—®ï¼š"æˆ‘è·Ÿæˆ‘è€å…¬ç¦»å©šéœ€è¦æˆ‘å¨˜å®¶çš„æˆ·å£è–„å—ï¼Ÿ"
  - æœç´¢è¯ï¼š"ç¦»å©šç™»è®° ææ–™ å¥³æ–¹æˆ·å£æœ¬ å¨˜å®¶ æ°‘æ³•å…¸ è§„å®š"
- **ä¼˜åŠ¿**: è·å–å®åŠ¡è§£è¯»è€Œéä»…æ³•æ¡åŸæ–‡

### æ•°æ®æµ

```
User Input
    â†“
CoreAgent (è¯†åˆ« + è·¯ç”±)
    â†“
SpecializedAgent (æ‰§è¡Œ + è¯„ä¼°)
    â†“
Tools (web_search, python_executor, etc.)
    â†“
SpecializedAgent (æ•´åˆç»“æœ)
    â†“
Critic (è¯„ä¼°)
    â†“ (å¦‚æœä¸é€šè¿‡)
é‡æ–°æœç´¢ + é‡æ–°ç”Ÿæˆ
    â†“
æœ€ç»ˆç»“æœ
    â†“
Frontend (æ˜¾ç¤º)
```

### çŠ¶æ€ç®¡ç†

**Agent çŠ¶æ€**:
- `IDLE`: ç©ºé—²çŠ¶æ€
- `RUNNING`: æ‰§è¡Œä¸­
- `FINISHED`: å®Œæˆ

**çŠ¶æ€è½¬æ¢**:
```
IDLE â†’ RUNNING (å¼€å§‹æ‰§è¡Œ)
    â†“
RUNNING â†’ FINISHED (ç”Ÿæˆæœ€ç»ˆå›ç­”)
    â†“
FINISHED â†’ IDLE (æ¸…ç†å®Œæˆ)
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# DashScope API Keyï¼ˆLLMå’ŒEmbeddingå…±ç”¨ï¼‰
export DASHSCOPE_API_KEY="sk-5d4975fe68f24d83809ac3c7bf7468ba"

# LLMé…ç½®ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"

# Bocha API Keyï¼ˆç”¨äºweb_searchï¼Œå¯é€‰ï¼‰
export BOCHA_API_KEY="your_bocha_api_key"
```

### é…ç½®æ–‡ä»¶

ä¸»è¦é…ç½®åœ¨ `config/config.py` ä¸­ï¼š

- **LLMé…ç½®**: `llm_model="qwen-max"`, `llm_base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"`
- **Embeddingé…ç½®**: `embedding_model="text-embedding-v4"`, `embedding_dim=1024`
- **å‘é‡æ•°æ®åº“é…ç½®**: `vector_db_path="./data/vector_db"`, `vector_db_collection="long_term_memory"`
- **æœ€å¤§æ­¥æ•°**: `max_steps=5` (ReActå¾ªç¯)
- **Criticè½®æ•°**: `max_critic_rounds=2`

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬å¯¹è¯

```python
from flow.legal_flow import LegalFlow
from config.config import Config
import asyncio

# åˆå§‹åŒ–é…ç½®
config = Config()

# åˆ›å»ºLegalFlowå®ä¾‹
legal_flow = LegalFlow(config)

# å¤„ç†ç”¨æˆ·æ¶ˆæ¯
user_message = "æˆ‘è·Ÿæˆ‘è€å…¬ç¦»å©šéœ€è¦æˆ‘å¨˜å®¶çš„æˆ·å£è–„å—ï¼Ÿ"
response = asyncio.run(legal_flow.execute(user_message))
print(response)
```

### è¿è¡Œè¯„ä¼°

```python
from eval.evaluator import Evaluator
from config.config import Config

config = Config()
evaluator = Evaluator(config)

# è¿è¡Œè¯„ä¼°ï¼ˆä»…Target Systemï¼‰
evaluator.evaluate(
    data_path="data/test_example/zixun_gpt4.json",
    max_cases=3,
    output_path="eval/results.json",
    run_baselines=False
)
```

## ğŸ¯ æ”¯æŒçš„æ³•å¾‹é¢†åŸŸ

- **åŠ³åŠ¨æ³•** (Labor_Law)
- **å©šå§»å®¶äº‹** (Family_Law)
- **åˆåŒçº çº·** (Contract_Law)
- **å…¬å¸æ³•** (Corporate_Law)
- **åˆ‘æ³•** (Criminal_Law)
- **ç¨‹åºæ€§é—®é¢˜** (Procedural_Query)

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹è¯„ä¼°æŒ‡æ ‡ï¼š

- **æœ‰æ•ˆæ€§æŒ‡æ ‡**:
  - æ³•æ¡å¼•ç”¨å¬å›ç‡ (Law Citation Recall)
  - è™šå‡å¼•ç”¨ç‡ (False Citation Rate)
  
- **ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡**:
  - å›ç­”å®Œæ•´æ€§ä¸é€»è¾‘æ€§ (LLM-as-a-Judge)
  - Criticæœ‰æ•ˆæ€§ (Critic Efficacy)
  - è·¯ç”±å‡†ç¡®æ€§ (Routing Accuracy)

## ğŸ› é”™è¯¯å¤„ç†

1. **è¯†åˆ«å¤±è´¥**: é»˜è®¤ä½¿ç”¨ Family_Law + QA_Retrieval
2. **å·¥å…·æ‰§è¡Œå¤±è´¥**: è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œç»§ç»­æ‰§è¡Œ
3. **è¯„ä¼°å¤±è´¥**: é»˜è®¤è®¤ä¸ºç»“æœå¯æ¥å—
4. **è¾¾åˆ°æœ€å¤§æ­¥æ•°**: å¼ºåˆ¶ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
5. **è¾¾åˆ°æœ€å¤§Criticè½®æ•°**: è¿”å›å½“å‰ç»“æœ

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **çŠ¶æ€é‡ç½®**: æ¯æ¬¡æ‰§è¡Œå‰ç¡®ä¿çŠ¶æ€ä¸º IDLE
2. **èµ„æºæ¸…ç†**: æ‰§è¡Œå®Œæˆåæ¸…ç†å·¥å…·èµ„æº
3. **ä¸Šä¸‹æ–‡çª—å£**: é™åˆ¶ recent_messages æ•°é‡ (30æ¡)
4. **æœ€å¤§æ­¥æ•°**: é™åˆ¶ ReAct å¾ªç¯æ­¥æ•° (5æ­¥)
5. **Criticè½®æ•°**: é™åˆ¶è¯„ä¼°å’Œé‡æ–°æœç´¢è½®æ•° (2è½®)

## ğŸ“ ç‰ˆæœ¬å†å²

### v2.0.0 (å½“å‰ç‰ˆæœ¬)

**é‡å¤§æ›´æ–°**:
- âœ… é‡æ„ä¸ºå¤šAgentæ¶æ„ï¼ˆCoreAgent + SpecializedAgentï¼‰
- âœ… å®ç°Native Function Callingå·¥å…·é€‰æ‹©
- âœ… æ·»åŠ ä¸¥æ ¼Criticæœºåˆ¶è¿›è¡Œè‡ªæˆ‘è¯„ä¼°
- âœ… åˆå¹¶embedding/llmä¸ºmodels/ç›®å½•
- âœ… åˆå¹¶memory/contextä¸ºç»Ÿä¸€memory/æ¨¡å—
- âœ… åˆ›å»ºé›†ä¸­åŒ–prompt/ç›®å½•
- âœ… æ›¿æ¢web_searchä¸ºBocha API
- âœ… æ·»åŠ å‰ç«¯å®æ—¶çŠ¶æ€æ˜¾ç¤º
- âœ… å®ç°State Memoryç”¨äºå…³é”®å®ä½“è¿½è¸ª
- âœ… æ·»åŠ è¯„ä¼°æ¨¡å—ä¸åŸºçº¿å¯¹æ¯”
- âœ… å¢å¼ºæœç´¢æŸ¥è¯¢ç”Ÿæˆï¼ˆå¤åˆè¯ï¼‰
- âœ… æ”¹è¿›å‰ç«¯æŒä¹…åŒ–æµç¨‹æ˜¾ç¤º
- âœ… ä¿®å¤å¤šä¸ªbugå¹¶æ”¹è¿›é”™è¯¯å¤„ç†

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæµç¨‹ç¤ºæ„å›¾](SYSTEM_FLOW_DIAGRAM.md) - è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„å’Œæ‰§è¡Œæµç¨‹
- [è¯„ä¼°æ¨¡å—æ–‡æ¡£](eval/README.md) - è¯„ä¼°ç³»ç»Ÿçš„ä½¿ç”¨è¯´æ˜
- [å·¥ä½œæµæ¶æ„æ–‡æ¡£](docs/WORKFLOW_ARCHITECTURE.md) - å·¥ä½œæµè®¾è®¡è¯´æ˜

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**ç³»ç»ŸçŠ¶æ€**: âœ… **v2.0.0 å·²å°±ç»ª** - æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡
